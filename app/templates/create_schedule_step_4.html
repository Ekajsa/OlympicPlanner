{% extends "base_template.html" %}
{% set active_page = "schedules" %}

{% block head %}
<script src="jquery-3.5.1.min.js"></script>
{% endblock %}

{%  block content12 %}
    <div class="content-section" style="max-height: inherit">
        <div class="container-fluid">
        <h1>Congratulations!</h1>
            <p> Here is a filtered version of the main schedule. If you like it as it is, you can
                copy all of it to your personal schedule. If you want, you can fine tune the main schedule with
                filters. Then you can either copy the whole main schedule to your personal schedule, or drag and
                drop to add events from the main schedule to your personal schedule. </p>
        </div>
        <div class="container-fluid overflow-auto" style="max-height: 80%">
            <div class="row">
                <div class="container col-md-7 overflow-auto">
                    {% for schedule in schedules %}
                        {% if shown_date in schedule[0] %}
                            <div class="base-schedule">
                                {{ schedule[1] | safe }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="container col-md-4 overflow-auto">
                    {% for personal_schedule in personal_schedules %}
                        {% if shown_date in personal_schedule[0] %}
                            <div class="personal-schedule">
                                {{ personal_schedule[1] | safe }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

    </div>
    {% for schedule in schedules %}
        {{ schedule[0] | safe }}
        <div class="base-schedule" id="base-schedule{{ loop.index }}">
            {{ schedule[1] | safe }}
        </div>
    {% endfor %}
    {% for personal_schedule in personal_schedules %}
        <div class="personal-schedule" id="personal-schedule{{ loop.index }}">
            {{ personal_schedule[1] | safe }}

        </div>
    <div class="row">
        <div class="container col-md-12">
            <form class="col-md-12  d-flex justify-content-center my-4" action="{{ url_for("bp_user.change_date_post") }}" method="POST">
                <div class="btn-group" role="group" aria-label="Change date-buttons">
                    <input type="submit" class="form-control mr-2" name="date_action" value="Today"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="First day"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Previous"/> <br/>
                    <input type="submit" class="form-control btn-info mr-2" name="date_action" value=" Showing: {{ shown_date }}"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Next"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Last day"/> <br/>
                    <input type="hidden" name="shown_date" value="{{ shown_date }}"/>
                </div>
            </form>
        </div>
    </div>
    </div>
{% endblock %}





{#{% block content4 %}#}
{#    <div>#}
{#        <table>#}
{#        <tr>#}
{#            <th></th>#}
{#            {% for column in priority_columns %}#}
{#                <th>{{ column }}</th>#}
{#            {% endfor %}#}
{#        </tr>#}
{#        {% for row in personal_schedule %}#}
{#            <tr>#}
{#                <td>{{ time_slots[loop.index - 1] }} </td>#}
{#                {% for cell in row %}#}
{#                    <td>{{ cell }}</td>#}
{#                {% endfor %}#}
{#            </tr>#}
{#        {% endfor %}#}
{#    </table>#}
{#    </div>#}
{#{% endblock %}#}


{% block scripts %}
<script>
    //Get all clone-me-td's and add moveIt() on click
    const clonableTds = document.querySelectorAll(".clone-me");
    clonableTds.forEach(div => {
        div.addEventListener("click", moveIt);
    });

    function moveIt(e) {
        // Get the div that we clicked
        let targetDiv = e.path[1];
        console.log('e:')
        console.log(e)
        console.log('targetDiv')
        console.log(targetDiv)
        // Get the cell hosting the div in the from table
        let targetCell = targetDiv.parentElement;
        console.log('targetCell:')
        console.log(targetCell)
        let targetTable = e.path[7];
        console.log('targetTable:')
        console.log(targetTable)
        let targetTableId = targetTable.id;
        console.log('targetTableId:')
        console.log(targetTableId)
        //Can I use jquery below to find parent table id?
        $(this).closest('table').attr('id')
        // Get the id of the row containing the div
        let parentRowId = e.path[3].rowIndex;
        console.log('parentRowId:')
        console.log(parentRowId)
        // Get the id of the row in the destination table
        let destinationRowId = 't' + parentRowId.substring(1);
        console.log('destinationRowId:')
        console.log(destinationRowId)
        // Get the current cells rowspan
        let rowspan = targetCell.rowSpan;
        console.log('rowspan:')
        console.log(rowspan)
        // Get the destination table
        let fromTable = null;
        let toTable = document.getElementById("personal-schedule");
        console.log('toTable:')
        console.log(toTable)
        // Remove the div from the original table
        targetDiv.parentElement.removeChild(targetDiv);

        // Iterate over the destination table row by row
        for (let row of toTable.rows) {
            // If we have found our destination row
            if(row.id === destinationRowId){
                // Add the div in the correct column
                //Here I want to add it to the second column (or the third if the second is occupied a.s.o.)
                row.cells[targetCell].appendChild(targetDiv);
                // Add the rowspan we want to this column. If no rowspan
                // was given, the value will be 1
                row.cells[targetCell.cellIndex].rowSpan = rowspan;
                // If we have a rowspan we need to delete the td's for as many
                // rows as the span is
                if(rowspan > 1) {
                    // Get the current row index
                    let rowIndex = targetCell.parentElement.rowIndex;
                    // and the column index
                    let cellIndex = targetCell.cellIndex;
                    // For each row below the one we inserted the div in
                    // we can now delete the td's
                    for(let i = 1; i < rowspan; i++) {
                        let row = toTable.rows[rowIndex + i];
                        row.deleteCell(cellIndex);
                    }
                }
            }
        }
    }
</script>
{% endblock %}
