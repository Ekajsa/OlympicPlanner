{% extends "base_template.html" %}
{% set active_page = "schedules" %}

{%  block content12 %}
    <div class="content-section" style="max-height: inherit">
        <div class="container-fluid">
        <h1>Congratulations!</h1>
            <p> Here is a filtered version of the main schedule. If you like it as it is, you can
                copy all of it to your personal schedule. If you want, you can fine tune the main schedule with
                filters. Then you can either copy the whole main schedule to your personal schedule, or drag and
                drop to add events from the main schedule to your personal schedule. </p>
        </div>
        <div class="container-fluid overflow-auto" style="max-height: 80%">
            <div class="row">
                <div class="container col-md-7 overflow-auto">
                    {% for schedule in schedules %}
                        {% if shown_date in schedule[0] %}
                            <div class="base-schedule" id="base-schedule{{ loop.index }}">
                                {{ schedule[1] | safe }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="container col-md-4 overflow-auto">
                    {% for personal_schedule in personal_schedules %}
                        {% if shown_date in personal_schedule[0] %}
                            <div class="personal-schedule" id="personal-schedule{{ loop.index }}">
                                {{ personal_schedule[1] | safe }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    <div class="row">
        <div class="container col-md-12">
            <form class="col-md-12  d-flex justify-content-center my-4" action="{{ url_for("bp_user.change_date_post") }}" method="POST">
                <div class="btn-group" role="group" aria-label="Change date-buttons">
                    <input type="submit" class="form-control mr-2" name="date_action" value="Today"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="First day"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Previous"/> <br/>
                    <input type="submit" class="form-control btn-info mr-2" name="date_action" value=" Showing: {{ shown_date }}"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Next"/> <br/>
                    <input type="submit" class="form-control mr-2" name="date_action" value="Last day"/> <br/>
                    <input type="hidden" name="shown_date" value="{{ shown_date }}"/>
                </div>
            </form>
        </div>
    </div>
    </div>
{% endblock %}





{#{% block content4 %}#}
{#    <div>#}
{#        <table>#}
{#        <tr>#}
{#            <th></th>#}
{#            {% for column in priority_columns %}#}
{#                <th>{{ column }}</th>#}
{#            {% endfor %}#}
{#        </tr>#}
{#        {% for row in personal_schedule %}#}
{#            <tr>#}
{#                <td>{{ time_slots[loop.index - 1] }} </td>#}
{#                {% for cell in row %}#}
{#                    <td>{{ cell }}</td>#}
{#                {% endfor %}#}
{#            </tr>#}
{#        {% endfor %}#}
{#    </table>#}
{#    </div>#}
{#{% endblock %}#}


{% block scripts %}
<script>
    //Get all clone-me-td's and add moveIt() on click
    const clonableTds = document.querySelectorAll(".clone-me");
    clonableTds.forEach(div => {
        div.addEventListener("click", moveIt);
    });
    let priorityColumn;
    function priorityCheck() {
        let text;
        priorityColumn = parseInt(prompt("Which priority column do you wish to move the event to?", "Choose 1-5"), 10);
        if (priorityColumn > 0 && priorityColumn < 6) {
            moveIt();
        } else {
            priorityCheck();
        }
        //document.getElementById("demo").innerHTML = text;
    }
    //Right-click menu!
    //document.getElementById("clicker").addEventListener('contextmenu', function(ev) {
            //ev.preventDefault();
            //alert('success!');
            //return false;
        //}, false);


    function moveIt(e) {
        // Get the div that we clicked
        let targetDiv = e.path[1];
        // Get the cell hosting the div in the from table
        let targetCell = targetDiv.parentElement;
        let targetTable = e.path[7];
        let targetTableId = targetTable.id;
        // Get the id of the row containing the div
        let parentRowId = e.path[3].rowIndex;
        // Get the id of the row in the destination table
        //let destinationRowId = 't' + parentRowId.substring(1);
        let destinationRowId = parentRowId;
        // Get the current cells rowspan
        let rowspan = targetCell.rowSpan;
        // Get the destination table
        let no = targetTableId.substring(13);
        console.log(e)
        let toTableDiv = document.getElementById("personal-schedule" + no);
        console.log('toTableDiv:')
        console.log(toTableDiv)
        let toTableDivId = toTableDiv.id;
        console.log('toTableDivId:')
        console.log(toTableDivId)
        let toTable = document.getElementById(toTableDivId).getElementsByTagName('table');
        console.log('toTable:')
        console.log(toTable)
        // Remove the div from the original table
        targetDiv.parentElement.removeChild(targetDiv);
        console.log('Here 1')
        // Iterate over the destination table row by row
        for (let row in toTable[0].firstElementChild.childNodes) {
            console.log('row')
            console.log(row)
            // If we have found our destination row
            if(row == destinationRowId){
                console.log('Here 3')
                // Add the div in the first available column
                toTable[0].firstElementChild.childNodes[row].cells[1].appendChild(targetDiv);
                let counter = 0;
                let cellsToRemove = [];
                console.log(toTable.rows)
                for (let cell in toTable.rows[row].cells) {
                    console.log('in for')
                    counter++;
                    if (counter > 5) {
                        console.log('in if')
                        cellsToRemove.push(cell);
                    }
                }
                console.log(cellsToRemove)
                for (let cell in cellsToRemove) {
                    row.removeChild(cell);
                }
                //Delete the last td in row
                //let lastCell = toTable[0].firstElementChild.childNodes[row].cells.at(-1);
                //toTable[0].firstElementChild.childNodes[0].cells.length
                // toTable[0].firstElementChild.childNodes[row].removeChild(rowLength - 1);
                // Add the rowspan we want to this column. If no rowspan
                // was given, the value will be 1
                toTable[0].firstElementChild.childNodes[row].cells[1].rowSpan = rowspan;
                // If we have a rowspan we need to delete the td's for as many
                // rows as the span is
                if(rowspan > 1) {
                    // Get the current row index
                    let rowIndex = targetCell.parentElement.rowIndex;
                    // and the column index
                    let cellIndex = targetCell.cellIndex;
                    // For each row below the one we inserted the div in
                    // we can now delete the td's
                    for(let i = 1; i < rowspan; i++) {
                        let row = toTable.rows[rowIndex + i];
                        row.deleteCell(cellIndex);
                    }
                } break;
            }
        }
    }
</script>
{% endblock %}
